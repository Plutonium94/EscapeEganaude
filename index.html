<!doctype html>
<html lang="fr">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<title>Escape from Eganaude</title>
</head>
<body>
	<style>
		span.h {
			margin-right: 40px;
		}

		span[data-ligne] + span.h {
			background-color: rgb(35, 200, 87);
			padding: 1px;
			border-radius:2px;
			color: #eeeeee;
		}

		span[data-ligne] {
			font-weight: bold;
			padding: 3px;
			margin-right: 60px;
			width:25px;
			text-align: center;
			display: inline-block;
		}

		span[data-ligne="1"] {
			background-color: yellow;
		}

		span[data-ligne="9"] {
			background-color: green;
		}

		span[data-ligne="12"] {
			background-color: maroon;
		}

		span[data-ligne="20"] {
			background-color: pink;
		}

		span[data-ligne="22"] {
			background-color: greenyellow;
		}

		span[data-ligne="100"] {
			background-color: red;
		}

		span[data-ligne="230"] {
			background-color: DarkOrange;
		}

		ul#destinations li {
			list-style-type: none;
		}

		section[data-direction][data-montre="true"] {
			display: block;
		}

		section[data-direction][data-montre="false"] {
			display: none;
		}

	</style>
	<h1>Escape from Eganaude</h1>
		

	<ul id="destinations">

	</ul>

	<main>

	</main>

	
	<script>

		var GRSA = 'Gare Routière Sophia Antipolis';
		var AMP = 'Amphores';
		var PEA = 'Pôle Echanges Antibes';
		var BA  = 'Bel Air';
		var SN = 'Square Nabonnand'; 

		var trajets = [{ligne : 1, direction: GRSA, horaires: [16.31, 17.05, 17.24, 17.52, 18.08, 18.27, 18.51, 19.15, 19.41, 20.18, 20.48, 22.16] },
			{ligne: 1, direction: AMP,
			horaires: [ 16.31, 17.01, 17.26, 17.51, 18.17, 18.36, 18.51, 19.16, 20.11, 20.46, 21.16, 22.41 ]},
			{ligne : 100, direction: GRSA, horaires: [16.20, 16.45, 17, 17.18, 18.02, 18.23, 18.43, 19.01, 19.33]},
			{ligne: 100, direction: PEA, horaires: [16.30, 16.45, 16.58, 17.07, 17.22,  17.42, 17.51, 18.11, 18.26, 18.50, 19.05, 19.30, 20.20]},
			{ligne: 12, direction: GRSA,
			horaires: [16.55, 17.3, 18.1, 18.45]}, 
			{ligne: 12, direction: PEA,
			horaires: [16.34, 17.14, 17.54, 18.29, 19.04]},
			{ligne: 22, direction: BA,
			horaires: [16.21, 17.22, 18.17, 19.12]},
			{ligne: 20, direction: GRSA,
			horaires: [17, 17.5, 18.52]},
			{ligne: 20, direction: SN,
			horaires: [16.35, 17.27, 18.21, 19.2]},
			{ligne: 230, direction: 'Nice par Promenade', 
			horaires: [16.34, 16.49, 17.04, 17.14, 17.24, 17.34, 17.44, 17.54, 18.04, 18.24, 18.34, 18.49, 19.04, 19.34, 20.14]},
			{ligne: 230, direction: 'Nice par Nice Nord',
			horaires: [16.53, 17.28, 17.58, 18.38, 19.18]}
			];	

		function listerProchainHoraires(lh) {
			var maintenant = new Date();
			maintenant = maintenant.getHours() + maintenant.getMinutes()/100.0;
			var res = lh.horaires.filter(function(h) {
				return h >= maintenant;
			});
			return res;
		}

		function listerDestinations() {
			var destinations = new Set();
			var res = '';
			trajets.forEach(function(lh, ind) {
				destinations.add(lh.direction);
			});
			destinations.forEach(function(d) {
				res += '<li><input type="checkbox"' +
					 'data-direction ="'+d+'" checked>'+d+'</li>';
			});
			document.getElementById('destinations').innerHTML = res;
		}

		function trierTrajets() {
			trajets.sort((a,b)=> {
				var cd = a.direction.localeCompare(b.direction);
				if(cd != 0)  { return cd; }
				return a.ligne - b.ligne;
			});
			console.log(trajets);
		}

		function listerTousHoraires() {
			var resContenu = '';
			var dernierDirection = '';
			trajets.forEach((ldh, ind)=> {
				if(dernierDirection != ldh.direction) {
					if(dernierDirection !== '') { resContenu += '</section>'} 
					resContenu += '<section data-direction="'+ldh.direction+'" data-montre="true"><h3>' + ldh.direction + '</h3>';
					dernierDirection = ldh.direction;
				}
				var prochainHoraires = listerProchainHoraires(ldh);
				prochainHoraires = prochainHoraires.map((h,ind)=> {
					h =  Math.floor(h * 100);
					var heures = Math.floor(h/100);
					var minutes = ('' + h%100).padStart(2,'0');
					return '<span class="h">' + heures + 'h' + minutes + '</span>';
				});
				resContenu += '<p><span data-ligne="' + ldh.ligne+'">'+ ldh.ligne + '</span> ' +  prochainHoraires.join('') + '</p>';

			});
			document.querySelector('main').innerHTML = resContenu;
		}

		function toggleVisibilityLignes() {
			document.querySelectorAll('ul#destinations li input[type="checkbox"]').forEach((checkbox, i)=> {
				checkbox.addEventListener('change', (evt)=> {
					var cb = evt.target;
					var direction = cb.getAttribute('data-direction');
					var section = document.querySelector('section[data-direction="'+ direction +'"]');
					if(section.getAttribute('data-montre')=='true') {
						section.setAttribute('data-montre','false');
					} else {
						section.setAttribute('data-montre', 'true');
					}
				})
			});
		}


		window.addEventListener('DOMContentLoaded', function(evt) {
			trierTrajets();
			listerDestinations();
			listerTousHoraires();
			toggleVisibilityLignes();
		});
	</script>


</body>
</html>
	